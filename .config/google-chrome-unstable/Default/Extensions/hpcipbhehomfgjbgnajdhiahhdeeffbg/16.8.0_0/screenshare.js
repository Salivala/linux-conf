const COLOR_SLOW="#964b00",COLOR_NO_VIEWERS="#ff0000",COLOR_VIEWERS="#7b9f18";var presenter=new Presenter;function startScreenShareForUser(e,t){presenter.startScreenShareForUser(e,t,account.getUserInfo())}function startBroadcastForUser(e,t){presenter.startBroadcastForUser(e,t,account.getUserInfo())}function resetChromeBadge(){chrome.browserAction.setBadgeText({text:""}),chrome.browserAction.setBadgeBackgroundColor({color:COLOR_NO_VIEWERS}),chrome.browserAction.setIcon({path:account.getIsAuthenticated()?"screenleap_icon_19_19.png":"screenleap_icon_19_19_off.png"})}function sendFrame(e,t){try{var r=t[0],n=r.url;if(presenter.getLockToTab()&&presenter.getLockToTab().id!=r.id||presenter.frameCount>0&&0==presenter.getNumActiveViewers()&&!presenter.screenShareInfo.recordScreenShare)return void presenter.setNextIntervalReady(e,"RTT",1e3);if(presenter.isCaptureEntireScreen()||presenter.getOption(presenter.RESTRICT_TO_FIRST_WINDOW)||0!=n.indexOf("chrome")||n==chrome.extension.getURL("markupPage.html"))if(presenter.getOption(presenter.RESTRICT_TO_FIRST_WINDOW)&&!presenter.restrictToWindowId&&(presenter.activeWindowId=r.windowId,presenter.restrictToWindowId=r.windowId),presenter.isCapturingEntireScreen()){var s=presenter.getVideo();s.width!=window.screen.width&&(s.width=window.screen.width),s.height!=window.screen.height&&(s.height=window.screen.height);var i=presenter.getVideoCanvas();i.width!=window.screen.width&&(i.width=window.screen.width),i.height!=window.screen.height&&(i.height=window.screen.height),i.getContext("2d").drawImage(s,0,0,s.width,s.height);var a=i.toDataURL("image/png");presenter.compareAndSendFrameIfDifferent(a,n,e)}else captureActiveTabAsDataUrl(r,presenter.restrictToWindowId?presenter.restrictToWindowId:r.windowId,e,function(t){presenter.compareAndSendFrameIfDifferent(t,n,e)},function(){presenter.setNextIntervalReady(e,"4b")});else presenter.setNextIntervalReady(e,"D")}catch(t){console.error("Exception while calling sendFrame: "+t),presenter.setNextIntervalReady(e,"E")}}function startNewShare(e){var t=!(!e||void 0===e.isCaptureEntireScreen)&&e.isCaptureEntireScreen;if(presenter.setOption(presenter.SHARE_ENTIRE_SCREEN,t),presenter.sharingState==sharingStates.STARTING);else if(presenter.sharingState==sharingStates.SHARING)!e||"GMAIL"!=e.origin&&"INTEGRATION"!=e.origin?dispatch.triggerOnAllTabs("startScreenShareUnsuccessful",{status:409}):dispatch.triggerOnAllTabs("insertLinkForActiveIntegrationScreenShare",{viewerUrl:presenter.getViewerUrl()});else if(!e||"GMAIL"!=e.origin&&"INTEGRATION"!=e.origin)account.getUserInfo()?startScreenShareForUser(e&&void 0!==e.origin?e.origin:"IN_BROWSER",e):e&&void 0!==e.userId&&void 0!==e.token?account.signInWithToken(e.userId,e.token,function(){startScreenShareForUser(e&&void 0!==e.origin?e.origin:"IN_BROWSER",e)},function(){dispatch.triggerOnAllTabs("startScreenShareUnsuccessful",{status:401})}):dispatch.triggerOnAllTabs("startScreenShareUnsuccessful",{status:401});else{presenter.origin=e.origin;var r=null;if("GMAIL"==e.origin)r=account.getIsAuthenticated()?account.getUserInfo():{emailAddress:e.emailAddress};else if("INTEGRATION"==e.origin){if(!account.getIsAuthenticated())return void dispatch.triggerOnAllTabs(t?"startIntegrationScreenShareUnsuccessful":"startIntegrationBrowserShareUnsuccessful",{status:401,event:"authenticate"});r=account.getUserInfo()}presenter.doStartScreenShare(e.origin,null,r,function(e){t?dispatch.triggerOnAllTabs("hideIntegrationScreenShareStartingDialog"):dispatch.triggerOnAllTabs("startIntegrationBrowserShareSuccessful",e)},function(e){dispatch.triggerOnAllTabs("startIntegrationScreenShareUnsuccessful",e)})}}dispatch.on("mousemove",function(e){presenter.mousePosition=e,presenter.activeWindowId&&e.devicePixelRatio&&(presenter.scalesForWindowIds[presenter.activeWindowId]=e.devicePixelRatio)}),dispatch.on("createMeeting",function(e){account.createMeeting(e)}),dispatch.on("initOnLoad",function(e,t,r){var n=presenter.getLockToTab();(!n||t.tab.id==n.id)&&r("activateWindow",{windowId:t.tab.windowId,sharingState:presenter.sharingState,captureEntireScreen:presenter.isCaptureEntireScreen()})}),dispatch.on("chatUpdate",function(e){presenter.updateChatProperties(e.chatIsVisible,e.chatIsOpen,e.chatConversation)}),presenter.on("change:sharingState",function(e){var t=e.action,r=e.sharingState,n=e.viewerUrl,s=getPopup();t==sharingActions.START?(s&&s.initSharingUI(r,presenter.screenShareInfo.hidePauseButton,presenter.screenShareInfo.hideStopButton,n,presenter.getDisableShareInstructions(),!0),chrome.browserAction.setIcon({path:"screenleap_icon_19_19.png"}),presenter.trigger("change:numViewers",{numViewers:0})):t==sharingActions.STOP||r==sharingStates.NONE?(s&&s.updateUIAndClosePopupWindow(r),resetChromeBadge()):s&&s.updatePauseButton(r)}),presenter.on("change:numViewers",function(e){if(presenter.isSharing()){var t=e.numViewers;chrome.browserAction.setBadgeText({text:t.toString()}),presenter.isNetworkSlow?chrome.browserAction.setBadgeBackgroundColor({color:"#964b00"}):t>0?chrome.browserAction.setBadgeBackgroundColor({color:"#7b9f18"}):chrome.browserAction.setBadgeBackgroundColor({color:COLOR_NO_VIEWERS})}}),presenter.on("net:slow",function(){chrome.browserAction.setBadgeBackgroundColor({color:"#964b00"})}),presenter.on("net:recover",function(){presenter.trigger("change:numViewers",{numViewers:presenter.getNumActiveViewers()})}),presenter.on("updateStatusLabel",function(e){var t=getPopup();t&&t.updateStatusLabel(e.label)}),presenter.on("copyToClipboard",function(e){copyToClipboard(e.text)}),presenter.on("unauthorized",function(){doSignOut(!1)}),dispatch.on("checkIsAuthenticated",function(){dispatch.triggerOnAllTabs("checkIsAuthenticatedResult",{isAuthenticated:getIsAuthenticated()})}),dispatch.on("authenticate",function(e){signIn(e.emailAddress,e.password)}),dispatch.on("startScreenShareWithData",function(e){e&&void 0!==e.isCaptureEntireScreen&&presenter.setOption(presenter.SHARE_ENTIRE_SCREEN,e.isCaptureEntireScreen),presenter.startScreenShareWithData(e)}),dispatch.on("startNewShare",startNewShare),dispatch.on("startNewBroadcast",function(e){var t=!(!e||void 0===e.isCaptureEntireScreen)&&e.isCaptureEntireScreen;if(presenter.setOption(presenter.SHARE_ENTIRE_SCREEN,t),presenter.setOption(presenter.BROADCAST_ACCESS_CODE,e.accessCode),presenter.sharingState==sharingStates.STARTING);else if(presenter.sharingState==sharingStates.SHARING)!e||"GMAIL"!=e.origin&&"INTEGRATION"!=e.origin?dispatch.triggerOnAllTabs("startScreenShareUnsuccessful",{status:409}):dispatch.triggerOnAllTabs(t?"insertLinkForActiveIntegrationScreenShare":"insertLinkForActiveIntegrationBrowserShare",{viewerUrl:presenter.getViewerUrl()});else if(!e||"GMAIL"!=e.origin&&"INTEGRATION"!=e.origin)account.getUserInfo()?startBroadcastForUser(e&&void 0!==e.origin?e.origin:"IN_BROWSER"):e&&void 0!==e.userId&&void 0!==e.token?account.signInWithToken(e.userId,e.token,function(){startBroadcastForUser(e&&void 0!==e.origin?e.origin:"IN_BROWSER")},function(){dispatch.triggerOnAllTabs("startScreenShareUnsuccessful",{status:401})}):dispatch.triggerOnAllTabs("startScreenShareUnsuccessful",{status:401});else{var r=null;if("GMAIL"==e.origin)r={emailAddress:e.emailAddress};else if("INTEGRATION"==e.origin){if(!account.getIsAuthenticated())return void dispatch.triggerOnAllTabs(t?"startIntegrationScreenShareUnsuccessful":"startIntegrationBrowserShareUnsuccessful",{status:401,event:"authenticate"});r=account.getUserInfo()}presenter.doStartBroadcast(e.origin,null,r,function(e){t?dispatch.triggerOnAllTabs("hideIntegrationScreenShareStartingDialog"):dispatch.triggerOnAllTabs("startIntegrationBrowserShareSuccessful",e)},function(e){dispatch.triggerOnAllTabs(t?"startIntegrationScreenShareUnsuccessful":"startIntegrationBrowserShareUnsuccessful",e)})}}),dispatch.on("stopSharing",function(){presenter.setDialogIsHidden(),presenter.stopScreenleap(!0,!0,"USER_ACTION")}),dispatch.on("sendChatMessage",function(e){presenter.sendChatMessage(e.message)}),dispatch.on("processMessage",function(e){presenter.processResponseData(e.message)}),dispatch.on("confirmScreenSwap",function(){presenter.setDialogIsHidden(),presenter.confirmScreenSwap()}),dispatch.on("denyScreenSwap",function(){presenter.setDialogIsHidden(),presenter.denyScreenSwap()}),dispatch.on("continueSharing",function(){presenter.setDialogIsHidden()}),dispatch.on("continueSharingWithFreebie",function(){presenter.setDialogIsHidden(),presenter.useFreebie()}),dispatch.on("startRecording",function(){presenter.startRecording()}),dispatch.on("stopRecording",function(){presenter.stopRecording()});try{var injectContentScripts=function(e,t){chrome.tabs.insertCSS(e,{file:"extension.css"}),chrome.tabs.executeScript(e,{file:"dispatchcontentscript.js"}),chrome.tabs.executeScript(e,{file:"contentscript.js"}),chrome.tabs.executeScript(e,{file:"iframecontentscript.js",allFrames:!0}),t&&(0==t.indexOf("https://www.google.com/calendar")?chrome.tabs.executeScript(e,{file:"gcal.js"}):0==t.indexOf("https://mail.google.com")||0==t.indexOf("https://inbox.google.com")?(chrome.tabs.executeScript(e,{file:"inboxsdk.js"}),chrome.tabs.executeScript(e,{file:"gmail.js"})):t.indexOf(".slack.com")>0&&chrome.tabs.reload(e))};chrome.runtime.onInstalled.addListener(function(){chrome.tabs.query({windowType:"normal"},function(e){for(var t=0;t<e.length;t++){var r=e[t];0!=r.url.indexOf("chrome://")&&0!=r.url.indexOf("https://chrome.google.com")&&function(e,t){var r=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);parseInt(r[2],10)>=41?chrome.tabs.sendMessage(e,{greeting:"hello"},null,function(r){r||injectContentScripts(e,t)}):chrome.tabs.sendMessage(e,{greeting:"hello"},function(r){r||injectContentScripts(e,t)})}(r.id,r.url)}})}),chrome.tabs.onActivated.addListener(function(e){if(presenter.isSharing()){var t=e.tabId;if(presenter.restrictToWindowId&&e.windowId!=presenter.restrictToWindowId)return;if(presenter.getLockToTab()&&presenter.getLockToTab().id!=t)return void console.log("ignoring tab "+t+" because it is not the locked tab "+presenter.lockToTab.id);chrome.tabs.get(t,function(e){if(e&&(e==markupPageTab||!e.url||0!=e.url.indexOf("chrome"))){if(presenter.activeWindowId=e.windowId,dispatch.trigger(e,"activateWindow",{windowId:e.windowId,sharingState:presenter.sharingState,captureEntireScreen:presenter.isCaptureEntireScreen(),chatIsVisible:presenter.chatIsVisible,chatIsOpen:presenter.chatIsOpen,chatConversation:presenter.chatConversation}),presenter.lastActiveTab){var t=presenter.lastActiveTab;chrome.tabs.query({active:!0,lastFocusedWindow:!0},function(e){!t||t in e||dispatch.trigger(t,"deactivateWindow")})}presenter.lastActiveTab=e}})}}),chrome.windows.onFocusChanged.addListener(function(e){presenter.getOption(presenter.RESTRICT_TO_FIRST_WINDOW)||e!=chrome.windows.WINDOW_ID_NONE&&presenter.isSharing()&&chrome.tabs.query({active:!0,windowId:e},function(t){t.length>0&&(dispatch.trigger(t,"activateWindow",{windowId:e,sharingState:presenter.sharingState,captureEntireScreen:presenter.isCaptureEntireScreen(),chatIsVisible:presenter.chatIsVisible,chatIsOpen:presenter.chatIsOpen,chatConversation:presenter.chatConversation}),chrome.windows.getAll({populate:!0},function(t){for(var r=0;r<t.length;r++){var n=t[r];if(n.id!=e)for(var s=0;s<n.tabs.length;s++)if(n.tabs[s].active){dispatch.trigger(n.tabs[s],"deactivateWindow");break}}}))})}),resetChromeBadge()}catch(e){const t="screenshare.js: failed to initialize";e instanceof ReferenceError?console.warn(t,e.stack):console.warn(t,e)}