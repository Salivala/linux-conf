var V2=function(t){var e={};function s(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:i})},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=new Error("deferred timeout");class n{constructor(t){let e;const s=new Promise((s,n)=>{let r=0;t>0&&(r=setTimeout(()=>n(i),t)),e={_resolve:s,_reject:n,timer:r}});Object.assign(this,e,{promise:s})}resolve(t){this.resetTimer(0),this._resolve(t)}reject(t){this.resetTimer(0),this._reject(t)}resetTimer(t){this.timer&&clearTimeout(this.timer),t>0&&(this.timer=setTimeout(()=>this._reject(i),t))}getPromise(){return this.promise}}function r(t){return new Promise(e=>setTimeout(e,t))}function o(t){const e=new Map;return t.forEach((t,s)=>e.set(t,s)),e}const a=window,h="withCredentials"in new a.XMLHttpRequest,l=h?a.XMLHttpRequest:a.XDomainRequest;let c=function(t,e){const s=Date.now(),{headers:r,_timeout:o}=e,a=new p(t,e),{method:l,body:c}=a,d=new n(0);let f=g.get();if(f.onload=(()=>{if(null==f)return;const t=f.status||parseInt(f.contentType,10),e=f.response||f.responseText;let i={status:t,statusText:f.responseText,headers:null};const n=new b(e,i,Date.now()-s);d.resolve(n),g.put(f),f=f.onload=f.onerror=f.ontimeout=null}),f.onerror=(t=>{null!=f&&(d.reject(u),f=f.onload=f.onerror=f.ontimeout=null)}),f.ontimeout=(()=>{null!=f&&(f.abort(),d.reject(i),g.put(f),f=f.onload=f.onerror=f.ontimeout=null)}),!h){f.onprogress=(()=>{});const e=-1==t.indexOf("?")?"?":"&";t=`${t}${e}xdr=1`}if(f.open(l,t),f.timeout=o||0,h&&(f.withCredentials="credentials"in e&&"include"==e.credentials,r))for(let[t,e]of Object.entries(r))f.setRequestHeader(t,e);return f.send(c),d.getPromise()};const u=new TypeError("fetch failed"),d="Body holds wrong type",g=new class{constructor(t,e){this.pool=[],Object.assign(this,{allocator:t,size:e})}get(){return this.pool.length>0?this.pool.shift():this.allocator()}put(t){this.pool.length<this.size&&this.pool.push(t)}}(()=>new l,10);class f{constructor(t){this.body=t}arrayBuffer(){return this.body instanceof ArrayBuffer?Promise.resolve(this.body):Promise.resolve(d)}text(){return"string"==typeof this.body?Promise.resolve(this.body):Promise.resolve(d)}json(){return this.text().then(JSON.parse)}}class p extends f{constructor(t,e){let{method:s,body:i}=e;s=s?s.toUpperCase():"GET",super(i),Object.assign(this,{method:s,url:t})}}class b extends f{constructor(t,e,s){const{status:i}=e,n=2==Math.floor(i/100);super(t),this.status=i,this.ok=n,this.elapsed=s}}const w=window,{RTCSessionDescription:m,RTCIceCandidate:S,WebSocket:y}=w,M=w.RTCPeerConnection||w.webkitRTCPeerConnection||w.mozRTCPeerConnection,C=w.crypto||w.msCrypto,v=C?C.subtle||C.webkitSubtle:null,O=5;class P{constructor(){this.table={}}add(t,e,s){let i=this.table[t];i||(i={},this.table[t]=i);let n=i[e];n||(n=[0,0,0,0],i[e]=n),n[0]+=s,n[1]+=1,n[2]=Date.now(),s>n[3]&&(n[3]=s)}record(t,e,s){let i=this.table[t];i||(i={},this.table[t]=i);let n=i[e];n||(n=[],i[e]=n),n.push(s),n.length>O&&n.shift()}getValue(t,e){return this.getField(t,e,0)}getCount(t,e){return this.getField(t,e,1)}getField(t,e,s){let i=this.table[t];if(!i)return 0;let n=i[e];return n?n[s]:0}output(){return JSON.stringify(this.table)}}const k="CTRL",$="META",D="DATA",j="DATA_REPLICA",T="WEB",L="AUDIO",x=["UNKNOWN",k,$,D,j,T,L],E=o(x);class R{onOpen(t){}onClose(t){}}class I{constructor(t,e,s){Object.assign(this,{role:t,host:e,regionCluster:s})}getUrl(t){return`https://${this.host}/${t}`}}class A{constructor(t){this.role=t,this.pool=new Map,this.cachedArr=[]}add(t,e){if(this.pool.has(t))return null;const s=new I(this.role,t,e);return this.pool.set(t,s),this.cachedArr=[],s}update(t){const e=this.pool;this.pool=new Map;const s=[];for(let i of t){null==i.regionCluster&&(i.regionCluster="");const t=this.add(i.hostname,i.regionCluster);e.has(i.hostname)?e.delete(i.hostname):t&&s.push(t)}const i=[];for(let t of e.values())i.push(t);return this.cachedArr=[],[s,i]}clear(){this.pool.clear(),this.cachedArr=[]}has(t){return this.pool.has(t)}getList(){if(0==this.cachedArr.length)for(let t of this.pool.values())this.cachedArr.push(t);return this.cachedArr}}class N{constructor(t,e){this.delegateList=[],this.idHash=0,this.domain=e;const s=x.map(t=>new A(t));Object.assign(this,{regionCluster:t,poolList:s})}addDelegate(t){this.delegateList.push(t)}onOpen(t){for(let e of this.delegateList)e.onOpen(t)}onClose(t){for(let e of this.delegateList)e.onClose(t)}finalize(){for(let t of this.poolList)this.clear(t.role)}update(t){const e=new Map;for(let s of t){s.regionCluster=s.regionCluster||"",s.hostname=F(s.hostname,this.domain);const t=e.get(s.role)||[];t.push(s),e.set(s.role,t)}for(let[t,s]of e){if(null==t)continue;const[e,i]=this.getPool(t).update(s);for(let t of e)this.onOpen(t);for(let t of i)this.onClose(t)}this.pickDataServer()}pickDataServer(){let t=this.getData();if(0==t.length)return;this.dataOrigin=t[0].host;let e=[];this.regionCluster!=t[0].regionCluster&&"UNSPECIFIED"!=this.regionCluster||e.push(t[0]);for(let t of this.getDataReplica())this.regionCluster!=t.regionCluster&&"UNSPECIFIED"!=this.regionCluster||e.push(t);0!==e.length?this.dataHost=e[this.idHash%e.length].host:this.dataHost=this.dataOrigin}getPool(t){const e=E.get(t)||0;return this.poolList[e]}add(t,e,s){const i=this.getPool(t).add(e,s);i&&this.onOpen(i)}has(t){return this.getPool(t.role).has(t.host)}clear(t){const e=this.getPool(t);for(let t of e.getList())this.onClose(t);e.clear()}getList(t){return this.getPool(t).getList()}getCtrl(){return this.getList(k)[0]}getMeta(){return this.getList($).slice(0,2)}getData(){return this.getList(D)}getDataReplica(){return this.getList(j)}getWeb(){return this.getList(T)[0]}getAudio(){let t=this.getList(L);return 0==t.length?null:t[0]}hasAudio(){return null!=this.getAudio()}setCtrl(t,e){null!=e&&""!=e||(e="UNSPECIFIED"),t=F(t,this.domain),this.clear(k),this.add(k,t,e)}}function F(t,e){let s=t;const i=t.split(":");let n=t=>t;if(2==i.length&&(s=i[0],n=(t=>t+":"+i[1])),s.endsWith(e))return n(s);const r=s.split(".");return r.length<=2?n(e):n(r.slice(0,r.length-2).join(".")+"."+e)}const W=8e3,H=6e4,q=4e3,U=1e3,J=3,z={"Content-Type":"text/plain"};class B{constructor(){this.headers={},this.delegateList=[],this.cliStats=new P}addDelegate(t){this.delegateList.push(t)}onFail(t){for(let e of this.delegateList)e.onFail(t)}setHeaders(t){Object.assign(this.headers,t)}post(t,e,s,i={},n=!1,r=0){const o=t.getUrl(e),a=Object.assign({},z,this.headers,i),h=s?s.length:0,l={headers:a,body:s,method:"POST",_timeout:W+r};n&&(l.credentials="include");const u=c(o,l);return u.then(e=>{200==e.status&&(this.cliStats.add("byteSentHttpPost",t.host,h),this.cliStats.add("timeSentHttpPost",t.host,e.elapsed))}).catch(()=>this.onFail(t)),u}ping(t,e){const s=t.getUrl(e),i=Object.assign({},z,this.headers),n=c(s,{headers:i,method:"POST",_timeout:q});return n.catch(()=>this.onFail(t)),n}get(t,e,s){const i=t.getUrl(e),n=Object.assign({},this.headers,s),r=c(i,{headers:n,_timeout:W});return r.catch(()=>this.onFail(t)),r}poll(t,e,s){const i=t.getUrl(e),n=Object.assign({},z,this.headers,s),r=c(i,{headers:n,method:"POST",_timeout:H});return r.catch(()=>this.onFail(t)),r}async postRetry(t,e,s){for(let i=0;i<J;i++){try{return await this.post(t,e,s)}catch(t){}await r(U)}return Promise.reject()}}const _=3e3,X=30,G=36e5/_,V=3,K=0,Q=1,Y="ONLINE",Z="OFFLINE",tt="STOPPED",et="SLOW",st="NORMAL";let it=1e4;class nt{constructor(t,e,s){this.isOffline=!1,this.isSlow=!1,this.slowImages=0,this.state=K,Object.assign(this,{delegate:t,srvMgr:e,httpCli:s})}finalize(){this.state=Q}async onFail(t){if(!this.isOffline&&!this.checkDfd){this.checkDfd=new n(0);try{return await this.ping(this.srvMgr.getCtrl()),void(this.checkDfd&&(this.checkDfd.resolve(),this.checkDfd=null))}catch(t){}try{return await this.ping(this.srvMgr.getWeb()),void(this.checkDfd&&(this.checkDfd.resolve(),this.checkDfd=null))}catch(t){}this.setOffline()}}ping(t){let e="echo";return t.role===T&&(e="status.txt"),this.httpCli.ping(t,e)}async checkReady(t){for(let e=0;e<X;e++)try{return await this.ping(t),!0}catch(t){}return!1}async roundTripTime(t){const e=Date.now();try{return await this.ping(t),Date.now()-e}catch(t){return 0}}async reconnect(){let t=0;for(;this.state===K;){if(t++>G)return console.log("could not reconnect. tried "+t+" times."),this.checkDfd&&this.checkDfd.resolve(),void this.delegate.onStatusChange(tt);try{await this.ping(this.srvMgr.getCtrl());break}catch(t){}try{await this.ping(this.srvMgr.getWeb());break}catch(t){}await r(_)}this.checkDfd&&(this.checkDfd.resolve(),this.checkDfd=null),this.state===K&&this.setOnline()}setOffline(){this.isOffline||(this.isOffline=!0,this.reconnect(),this.delegate.onStatusChange(Z),this.abortDfd&&this.abortDfd.reject(new Error("offline abort")))}setOnline(){this.isOffline&&(this.isOffline=!1,this.delegate.onStatusChange(Y))}setAbortable(t){this.abortDfd=t}monitorSpeed(t){if(this.isSlow)t<=it?(this.slowImages--,0==this.slowImages&&(this.isSlow=!0,this.delegate.onStatusChange(st))):this.slowImages<V&&(this.slowImages=V);else if(t>it){if(this.slowImages++,this.slowImages>=V){this.isSlow=!0;const e=(t%6e4/1e3).toFixed(0);this.delegate.onStatusChange(et+"|"+e)}}else this.slowImages>0&&(this.slowImages=0)}}const rt=0,ot=1,at=2,ht=3,lt=0,ct=1,ut=100,dt=3e3,gt=4e3,ft=3,pt=30,bt=(new Error("http not ok"),new Error("WebSocket error"));class wt{onOpen(t,e){}onClose(t,e){}onMessage(t,e){}onError(t,e){}}class mt{constructor(t,e,s,i,n){this.mode=lt,this.state=rt,this.isPollingXHR=!1,this.cliStats=new P,Object.assign(this,{delegate:t,httpCli:e,netMon:s,srv:i,pathGen:n})}open(){this.mode=lt,this.state=rt,this.pollingXHR()}close(){switch(this.state){case rt:case ot:this.state=at}}async pollingXHR(){if(!this.isPollingXHR){for(this.isPollingXHR=!0;;){const t=await this.pollLocked();if(t<0)break;await r(t)}this.isPollingXHR=!1}}async pollLocked(){switch(this.state){case at:this.state=ht;case ht:return this.onClose(),-1}if(this.mode!==lt)return-1;let t=ut;try{this.netMon.checkDfd&&await this.netMon.checkDfd.getPromise();const e=this.pathGen.next(),s=await this.httpCli.poll(this.srv,e);switch(s.status){case 200:case 204:const e=await s.text();this.state===rt&&(this.state=ot,this.onOpen()),e.length>0&&this.onMessage(e);break;case 404:return-1;default:t=dt}}catch(e){this.onError(e),t=dt}return t}send(t,e){switch(this.state){case at:case ht:return Promise.reject()}const s=this.pathGen.pub(t);return this.cliStats.add("byteSentMetaXHR",this.srv.host,e.length),this.httpCli.postRetry(this.srv,s,e)}onOpen(){this.delegate.onOpen(this.srv,this.mode)}onClose(){this.delegate.onClose(this.srv,this.mode)}onMessage(t){switch(this.delegate.onMessage(this.srv,t),this.mode){case lt:this.cliStats.add("byteRecvMetaXHR",this.srv.host,t.length);break;case ct:this.cliStats.add("byteRecvMetaWS",this.srv.host,t.length)}}onError(t){this.delegate.onError(this.srv,t)}}class St extends mt{constructor(t,e,s,i,n){super(t,e,s,i,n),this.ws=null,this.retryWS=0,this.isPingingWS=!1,this.lastRxTime=0}close(){super.close(),this.closeWS()}send(t,e){return this.mode==ct&&this.ws&&this.ws.readyState==ot&&(this.ws.send(e),this.cliStats.add("byteSentMetaWS",this.srv.host,e.length)),super.send(t,e)}onOpen(){this.mode===lt&&this.connectWS(),this.delegate.onOpen(this.srv,this.mode)}onError(t){switch(this.closeWS(),this.state){case at:case ht:return}switch(this.mode){case lt:this.connectWS();break;case ct:super.open()}this.delegate.onError(this.srv,t)}connectWS(){if(this.ws||this.netMon.isOffline||this.retryWS++>pt)return;const t=this.pathGen.next(),e=this.srv.getUrl(t).replace("https://","wss://"),s=this.ws=new y(e);s.onopen=(()=>{this.mode=ct,this.retryWS=0,this.lastRxTime=Date.now(),this.pingWS(),this.onOpen()}),s.onmessage=(t=>{this.lastRxTime=Date.now(),"string"==typeof t.data&&this.onMessage(t.data)}),s.onerror=(()=>this.onError(bt)),s.onclose=(t=>{const e=new Error(`WebSocket close: ${t.code}`);this.onClose(),this.onError(e)})}closeWS(){const t=this.ws;t&&(t.onopen=t.onclose=t.onerror=t.onmessage=null,t.close(),this.ws=null)}async pingWS(){if(!this.isPingingWS){for(this.isPingingWS=!0;this.ws&&this.ws.readyState==ot;){const t=this.ws,e=Date.now()-this.lastRxTime;if(e>gt*ft){this.netMon.onFail(this.srv),this.onError(i);break}e>gt&&t.send(new Uint8Array(1)),await r(gt)}this.isPingingWS=!1}}}class yt extends R{constructor(t,e,s,i,n){super(),this.subTable=new Map,this.srvChTable=new Map,this.cliStats=new P,this.useWS=!0,Object.assign(this,{delegate:t,srvMgr:e,httpCli:s,netMon:i,useWS:n})}subscribe(t,e){this.subTable.set(t,e);const s=this.srvMgr.getMeta();for(let t of s)this.onOpen(t)}unsubscribe(t){for(let[e,s]of this.srvChTable){const e=s.get(t);e&&(e.close(),s.delete(t))}this.subTable.delete(t)}send(t,e,s){this.srvMgr.getMeta();const i=[];for(let[n,r]of this.srvChTable){const n=r.get(t);n&&i.push(n.send(e,s))}return function(t){if(1===t.length)return t[0];const e=[],s=s=>{if(e.push(s),e.length>=t.length)throw e;return Promise.race([])},i=t.map(t=>t.catch(s));return Promise.race(i)}(i)}finalize(){for(let[t,e]of this.srvChTable){for(let[t,s]of e)s.close();e.clear()}this.srvChTable.clear(),this.subTable.clear()}onOpen(t){if(t.role!==$)return;let e=this.srvChTable.get(t.host);e||(e=new Map,this.srvChTable.set(t.host,e));for(let[s,i]of this.subTable){if(e.has(s))continue;let n;(n=this.useWS&&y?new St(this.delegate,this.httpCli,this.netMon,t,i):new mt(this.delegate,this.httpCli,this.netMon,t,i)).cliStats=this.cliStats,e.set(s,n),n.open()}}onClose(t){if(t.role!==$)return;const e=this.srvChTable.get(t.host);if(e){for(let[t,s]of e)s.close();e.clear(),this.srvChTable.delete(t.host)}}}const Mt=function(){const t=new Map;for(let e of window.location.hash.substr(1).split("&")){const[s,i]=e.split("=");t.set(s,i)}return t}(),Ct=Mt.has("debug")?parseInt(Mt.get("debug"),10):0;class vt{constructor(){this.verbose=Ct,this.table=new Map}log(t,...e){this.verbose>=t&&(console.log(...e),this.push("hist","log",e))}push(t,e,s){if(0===this.verbose)return;let i=this.table.get(t);null==i&&(i=new Map,this.table.set(t,i));let n=i.get(e);null==n&&(n=[],i.set(e,n));const r=JSON.parse(JSON.stringify(s,vt.jsonReplacer));n.push([Date.now(),r])}static jsonReplacer(t,e){if(!(this instanceof Map))return e;const s=this.get(t);return s&&s.toJSON?Object.assign({},s):Array.isArray(e)?e.slice(0):e}}const Ot=new vt;window.SLDEBUG=Ot;var Pt=Ot;const kt=["unknown","image/jpeg","image/png"],$t=o(kt);class Dt{constructor(t,e,s){Object.assign(this,{mimeType:t,offset:e,length:s})}toJSON(){let t=0;const e=$t.get(this.mimeType);return"number"==typeof e&&(t=e),[t,this.offset,this.length]}static fromList(t){let[e,s,i]=t;return e>=kt.length&&(e=0),new Dt(kt[e],s,i)}}class jt{constructor(t,e,s=0,i=0){Object.assign(this,{width:t,height:e,x:s,y:i})}equal(t){return this.width===t.width&&this.height===t.height&&this.x===t.x&&this.y===t.y}contain(t){return t.x-this.x>=0&&t.y-this.y>=0&&t.x+t.width-this.x-this.width<=0&&t.y+t.height-this.y-this.height<=0}toJSON(){return[this.width,this.height,this.x,this.y]}static fromList(t){return new jt(...t)}static fromObj({width:t,height:e,x:s,y:i}){return new jt(t,e,s,i)}static sortSizeDesc(t,e){return e.width*e.height-t.width*t.height}}class Tt{constructor(t,e){this.skip=!1,Object.assign(this,{data:t,rect:e})}toJSON(){return[this.data,this.rect]}static fromList(t){const[e,s]=t;return new Tt(Dt.fromList(e),jt.fromList(s))}}class Lt{constructor(t,e,s,i,n,r){this.skip=!1,this.useDiff=!1,Object.assign(this,{id:t,ts:e,view:s,sub:i,key:n,diff:r})}getLength(){return this.sub.reduce((t,e)=>t+e.data.length,0)}isFullFrame(){return 1==this.sub.length&&this.view.equal(this.sub[0].rect)}toJSON(){return[this.id,this.ts,this.view,this.sub,this.key,this.diff]}hasDiff(){return 0!=this.diff.length}static fromList(t){const[e,s,i,n,r,o]=t,a=n.map(t=>Tt.fromList(t));let h=[];return o&&(h=o.map(t=>Tt.fromList(t))),new Lt(e,s,jt.fromList(i),a,r,h)}}const xt="ff",Et="df",Rt="mp",It="ct",At="hs",Nt="su",Ft="ss",Wt="en",Ht="rq",qt="cr",Ut="mc",Jt="dl",zt="cb",Bt="fu",_t="ws",Xt=0,Gt=1;class Vt{constructor(t,e,s,i){Object.assign(this,{id:t,src:e,hdr:s,data:i})}toJSON(){return Object.values(this)}static fromList(t){return new Vt(t[0],t[1],t[2],t[3])}}class Kt{constructor(t,e){this.msgId=0,Object.assign(this,{src:t,mode:e})}newMessage(t,e){let s=0;switch(this.mode){case Xt:s=this.msgId,this.msgId++;break;case Gt:(s=Date.now())<=this.msgId&&(s=this.msgId+1),this.msgId=s}return new Vt(s,this.src,t,e)}}class Qt{constructor(){this.seqTable=new Map,this.msgTable=new Map}filter(t){const e=[];for(let s of t){const{id:t,src:i}=s;this.allowSeq(t,i)&&(Pt.push("msgRx",i,s),this.seqTable.set(i,t),e.push(s))}return e}resetSeq(t){this.seqTable.set(t,-1)}getSeq(t){if(this.seqTable.has(t)){const e=this.seqTable.get(t);if("number"==typeof e)return e}return-1}allowSeq(t,e){const s=this.getSeq(e);return t>s||0==t&&0!==s}}const Yt=new Error("cache cleared");class Zt{constructor(t){this.table=new Map,this.queue=[],this.wait=new Map,Object.assign(this,{size:t})}set(t,e){if(this.table.has(t)){const e=this.queue.indexOf(t);return void(e>-1&&(this.queue.splice(e,1),this.queue.push(t)))}this.table.set(t,e),this.queue.push(t);const s=this.wait.get(t);if(s&&s.resolve(e),this.queue.length<=this.size)return;const i=this.queue.shift();this.table.delete(i)}get(t){return this.table.get(t)}has(t){return this.table.has(t)}getAsync(t,e){const s=this.get(t);if(s)return Promise.resolve(s);if(0===e)return Promise.reject(i);let r=this.wait.get(t);if(!r){const s=()=>this.wait.delete(t);(r=new n(e)).getPromise().then(s).catch(s),this.wait.set(t,r)}return r.getPromise()}clear(){this.table.clear(),this.queue.splice(0,this.queue.length);for(let[t,e]of this.wait)e.reject(Yt);this.wait.clear()}}const te="open",ee="closed",se="arraybuffer",ie="screenleap",ne=[{urls:"stun:stun.l.google.com:19302"}],re=!!M;class oe{onSdp(t,e){}onState(t,e){}onMessage(t,e){}}class ae{constructor(t,e){const s=new M({iceServers:ne});s.onicegatheringstatechange=(()=>{if("complete"==s.iceGatheringState){const t=JSON.parse(JSON.stringify(s.localDescription));this.delegate.onSdp(this.peerId,t)}}),s.ondatachannel=(t=>{this._setupChan(t.channel)}),Object.assign(this,{peerId:t,delegate:e,conn:s})}offer(){const t=this.conn.createDataChannel(ie);this._setupChan(t),this.conn.createOffer(t=>{this.conn.setLocalDescription(t)},t=>{})}answer(){this.conn.createAnswer(t=>{this.conn.setLocalDescription(t)},t=>{})}setSdp(t){const e=new m(t);this.conn.setRemoteDescription(e)}send(t){this.chan&&this.chan.readyState===te&&this.chan.send(t)}getBuffered(){return this.chan?this.chan.bufferedAmount:1/0}close(){const{chan:t,conn:e}=this;t&&(t.onmessage=t.onopen=t.onclose=null,t.close()),e.onicecandidate=e.ondatachannel=null,"closed"!=e.signalingState&&"closed"!=e.connectionState&&e.close()}_setupChan(t){t.binaryType=se,t.onopen=(()=>{this.delegate.onState(this.peerId,te)}),t.onclose=(()=>{this.close(),this.delegate.onState(this.peerId,ee)}),t.onmessage=(t=>{"string"!=typeof t.data?t.data instanceof ArrayBuffer?this.delegate.onMessage(this.peerId,new Uint8Array(t.data)):console.log("Invalid type in call to onmessage"):this.delegate.onMessage(this.peerId,t.data)}),Object.assign(this,{chan:t})}}class he{constructor(t){this.table=new Map,Object.assign(this,{delegate:t})}finalize(){for(let[t,e]of this.table)e.close();this.table.clear()}offer(t){this.create(t).offer()}setSdp(t,e){switch(e.type){case"offer":{const s=this.create(t);s.setSdp(e),s.answer();break}case"answer":{const s=this.table.get(t);if(!s)return;s.setSdp(e);break}}}send(t,e){const s=this.table.get(t);s&&s.send(e)}getBuffered(t){const e=this.table.get(t);return e?e.getBuffered():1/0}close(t){const e=this.table.get(t);e&&(e.close(),this.table.delete(t))}create(t){this.close(t);const e=new ae(t,this.delegate);return this.table.set(t,e),e}}const le=32,ce=16384,ue=16*ce,de=1e3,ge=new Error("no peer"),fe=new Error("no available peer"),pe=new Error("tx rejected"),be=new Error("tx failed"),we=new Error("peer closed"),me=new Error("wrong msg format"),Se=0,ye=1,Me=2,Ce=3,ve=4,Oe=5,Pe=6,ke=re;class $e{onSignaling(t,e,s){}onOpen(t,e){}onClose(t,e){}}class De{constructor(t,e){const s=e.byteLength;Object.assign(this,{key:t,buflen:s,buffer:e})}toJSON(){const{key:t,buflen:e}=this;return{key:t,buflen:e}}getBlob(t,e,s){const{URL:i,Blob:n}=window;-1===s&&(s=this.buffer.byteLength);const r=new n([this.buffer.slice(e,e+s)],{type:t});return i.createObjectURL(r)}}class je{constructor(t,e){this.offset=0;const s=new Uint8Array(e);Object.assign(this,{key:t,buflen:e,bufview:s})}append(t){this.bufview.set(t,this.offset),this.offset+=t.byteLength}done(){return this.offset===this.buflen?[new De(this.key,this.bufview),!0]:[null,!1]}}class Te{constructor(t){Object.assign(this,{dfd:t})}processMessage(t,e){switch(t){case ye:this.doReject();break;case Me:"string"==typeof e&&this.doHeader(e);break;case Ce:e instanceof Uint8Array&&this.doPayload(e);break;case ve:"string"==typeof e&&this.doTrailer(e)}}doReject(){this.dfd.reject(pe)}doHeader(t){const{key:e,buflen:s}=JSON.parse(t);this.dfd.resetTimer(de);const i=new je(e,s);Object.assign(this,{tx:i})}doPayload(t){this.tx.append(t)}doTrailer(t){const[e,s]=this.tx.done();s&&e&&e.key===t?this.dfd.resolve(e):this.dfd.reject(be)}}class Le{constructor(t){this.latency=0,this.count=0,Object.assign(this,{peerId:t})}update(t){this.latency+=t,this.count++}static sort(t,e){const s=t.count||1,i=e.count||1;return t.latency/s-e.latency/i}}class xe{constructor(){this.table=new Map,this.list=[]}add(t){this.table.set(t,null),this.list.push(new Le(t))}reset(t){this.table.set(t,null)}get(t){return[this.table.get(t),this.table.has(t)]}keys(){return Array.from(this.table.keys())}del(t){const e=this.table.get(t);e&&e.dfd.reject(we),this.table.delete(t);const s=this.findIndex(t);-1!==s&&this.list.splice(s,1)}clear(){for(let[t,e]of this.table)e&&e.dfd.reject(we);this.table.clear(),this.list.splice(0,this.list.length)}newTransfer(t){if(0===this.list.length)return t.reject(ge),"";let e="";for(let t of this.list){const[s,i]=this.get(t.peerId);if(i&&null===s){e=t.peerId;break}}if(""===e)return t.reject(fe),"";const s=()=>this.reset(e);t.getPromise().then(s).catch(s);const i=new Te(t);return this.table.set(e,i),e}updateLatency(t,e){const s=this.findIndex(t);-1!==s&&(this.list[s].update(e),this.list.sort(Le.sort))}findIndex(t){for(let e=0;e<this.list.length;e++)if(this.list[e].peerId==t)return e;return-1}}class Ee extends oe{constructor(t,e,s){super(),this.dataCache=new Zt(le),this.peerTable=new xe,this.isLoopback=!1,this.isReady=!1;const i=new he(this);Object.assign(this,{selfId:t,delegate:e,cacheWait:s,pcMgr:i})}finalize(){this.pcMgr.finalize(),this.dataCache.clear(),this.peerTable.clear()}startLoopback(){ke&&(this.isLoopback=!0,this.pcMgr.offer("loopback"))}start(t){ke&&this.pcMgr.offer(t)}setSignaling(t){if(!ke)return;const e={type:t.type,sdp:t.sdp};this.pcMgr.setSdp(t.src,e)}set(t,e){const s=new De(t,e);this.dataCache.set(t,s)}has(t){return this.dataCache.has(t)}get(t){if(!ke)return Promise.reject(ge);const e=this.dataCache.get(t);if(e)return Promise.resolve(e);const s=new n(de),i=s.getPromise(),r=this.peerTable.newTransfer(s);if(""===r)return i;const o=Re(Se,t);return this.pcMgr.send(r,o),i.then(t=>{this.dataCache.set(t.key,t)}),i}onSdp(t,e){if(this.isLoopback){const s="loopback"==t?"localhost":"loopback";return void this.pcMgr.setSdp(s,e)}const s={type:e.type,sdp:e.sdp,src:this.selfId,dst:t},i=JSON.stringify(s);this.delegate.onSignaling(this.selfId,t,i)}onState(t,e){if(this.isLoopback)e==te&&(this.isLoopback=!1,this.pcMgr.close("loopback"),this.pcMgr.close("localhost"));else switch(e){case te:this.peerTable.add(t),this.updateLatency(),this.isReady=!0,this.delegate.onOpen(this.selfId,t);break;case ee:this.peerTable.del(t),this.delegate.onClose(this.selfId,t)}}onMessage(t,e){if("string"!=typeof e){const[s]=this.peerTable.get(t);return void(s&&s.processMessage(Ce,e))}const[s,i,n]=function(t){const e=JSON.parse(t);if(2!==e.length)return[0,"",me];return[...e,null]}(e);if(!n)switch(s){case Se:this.doPeerRequest(t,i);break;case ye:case Me:case ve:{const[e]=this.peerTable.get(t);e&&e.processMessage(s,i);break}case Oe:this.doPeerPing(t,i);break;case Pe:this.doPeerPong(t,i)}}async doPeerRequest(t,e){let{data:s,err:i}={};try{s=await this.dataCache.getAsync(e,this.cacheWait)}catch(t){i=t}if(i||this.pcMgr.getBuffered(t)>ue){const s=Re(ye,e);return void this.pcMgr.send(t,s)}const n=JSON.stringify(s),r=Re(Me,n);this.pcMgr.send(t,r);const{buflen:o,buffer:a}=s;for(let e=0;e<o;e+=ce){let s=e+ce;s>o&&(s=o),this.pcMgr.send(t,a.slice(e,s))}const h=Re(ve,e);this.pcMgr.send(t,h)}doPeerPing(t,e){const s=Re(Pe,e);this.pcMgr.send(t,s)}doPeerPong(t,e){const s=Number.parseInt(e,10),i=Date.now()-s;this.peerTable.updateLatency(t,i)}updateLatency(){const t=this.peerTable.keys();for(let e of t){const t=Date.now().toString(),s=Re(Oe,t);this.pcMgr.send(e,s)}}}function Re(t,e){return JSON.stringify([t,e])}const Ie=15e3,Ae=["unknown","mousemove","mousedown","mouseup","touchmove","touchstart","touchend"],Ne=o(Ae);class Fe{constructor(t,e,s,i,n){Object.assign(this,{eventType:t,x:e,y:s,ts:i,src:n})}toJSON(){const[t,...e]=Object.values(this);let s=0;return"string"==typeof t&&(s=Ne.get(t)||0),[s,...e]}static fromList(t){let[e,...s]=t;return e>=Ae.length&&(e=0),new Fe(Ae[e],s[0],s[1],s[2],s[3])}}class We{constructor(t){this.id=t,this.lastPointer=new Fe("",0,0,0,"")}newPointer(t,e,s){const i=Date.now(),{eventType:n,x:r,y:o,ts:a}=this.lastPointer;return t===n&&e===r&&s===o&&i-a<Ie?null:(this.lastPointer.eventType=t,this.lastPointer.x=e,this.lastPointer.y=s,this.lastPointer.ts=i,this.lastPointer.src=this.id,this.lastPointer)}}const He=new Error("no available server"),qe=3e4,Ue=0,Je=1,ze=2,Be=3;class _e{constructor(t,e,s){this.state=Ue,this.httpCli=new B,this.cliStats=new P;const i=Date.now();this.srvMgr=new N(e,s),this.httpCli.cliStats=this.cliStats,Object.assign(this,{delegate:t,ts:i})}initTransport(t,e,s){if(this.state!=Ue)return;this.state=Je,Object.assign(this,{id:t,session:e});const i=new Ve(this);this.netMon=new nt(i,this.srvMgr,this.httpCli),this.httpCli.addDelegate(this.netMon);const n=new Ge(this);this.chMgr=new yt(n,this.srvMgr,this.httpCli,this.netMon,s),this.srvMgr.addDelegate(this.chMgr),this.chMgr.cliStats=this.cliStats,this.msgMgr=new Qt}initPeerCache(t){const e=new Xe(this);Object.assign(this,{peerCache:new Ee(this.id,e,t)})}startTransport(){this.state==Je&&(this.state=Be,this.cliStatsLoop())}async cliStatsLoop(){for(;;){if(await r(qe),this.state<Be)return;try{await this.sendCliStats()}catch(t){}}}resolveHosts(){const t=[];for(let e of this.srvMgr.getMeta())t.push(this.httpCli.get(e,"up"));for(let e of this.srvMgr.getData())t.push(this.httpCli.get(e,"up"));Promise.all(t).catch(t=>{console.log("Error checking hosts: "+t)})}sendCliStats(){const{session:t,id:e,ts:s}=this,i=this.cliStats.output(),n=`common/stats/${t}/${e}/${s}`,r=this.srvMgr.getCtrl();return this.httpCli.postRetry(r,n,i)}finalize(){this.state>=Be&&(this.sendCliStats().catch(()=>{}),console.log(this.cliStats.output())),this.state=ze,this.peerCache&&this.peerCache.finalize(),this.chMgr&&this.chMgr.finalize(),this.netMon&&this.netMon.finalize(),this.srvMgr.finalize()}updateServers(t){this.srvMgr.update(t)}receive(t,e){const[s,i]=function(t){try{const e=t.slice(0,-1);return[JSON.parse(`[${e}]`).map(t=>Vt.fromList(t)),null]}catch(t){return[null,t]}}(e);if(i)return i;if(null==s)return new Error("decode: missing msgList");const n=this.msgMgr.filter(s);for(let t of n)this.delegate.onMessage(t),this.handleMessage(t);return n.length>0&&this.cliStats.add("countRecvMeta",t.host,n.length),this.cliStats.add("countRecvMetaRaw",t.host,s.length),null}handleMessage(t){const e=this.getHandler(t.hdr);return e?e(t):(console.log("Transport.handleMessage: unhandled message",t.hdr),null)}getHandler(t){let e;switch(t){case _t:e=this.$$ws;break;case At:e=this.$$hs;break;case It:e=this.$$ct;break;case Nt:e=this.$$su;break;case Wt:e=this.$$en;break;case Ut:e=this.$$mc}return null==e?null:e.bind(this)}$$ws(t){if(!this.peerCache)return null;this.peerCache.setSignaling(t.data)}$$hs(t){return this.srvMgr.update(t.data),null}$$ct(t){return this.srvMgr.setCtrl(t.data,"UNSPECIFIED"),null}$$su(t){switch(t.data){case"PAUSED":this.delegate.onSessionStatus(["PAUSE"]);break;case"SHARING":this.delegate.onSessionStatus(["RESUME"])}return null}$$en(t){return this.delegate.onSessionStatus(["END",t.data]),null}$$mc(t){return this.delegate.onPresenterSwap(["MOVE",t.data]),null}}class Xe extends $e{constructor(t){super(),Object.assign(this,{self:t})}onSignaling(t,e,s){const{session:i}=this.self,n=`common/signaling/${i}/${e}`,r=this.self.srvMgr.getCtrl();this.self.httpCli.postRetry(r,n,s)}onOpen(t,e){console.log("PeerCache onOpen",t,e),this.self.delegate.onPeerConn(e)}onClose(t,e){console.log("PeerCache onClose",t,e)}}class Ge extends wt{constructor(t){super(),Object.assign(this,{self:t})}onOpen(t,e){Pt.log(1,"Channel: onOpen",t.host,e)}onClose(t,e){Pt.log(1,"Channel: onClose",t.host,e)}onMessage(t,e){const s=this.self.receive(t,e);s&&console.log("Transport.onMessage error",s)}onError(t,e){console.log("onError",t.host,e.message)}}class Ve{constructor(t){Object.assign(this,{self:t})}onStatusChange(t){this.self.delegate.onNetworkStatus(t)}}const Ke="SHA-256",Qe={"+":"-","/":"_","=":""};async function Ye(t){if(null==v){const t="browser is missing cryptoSubtle";return console.log(t),t}try{return function(t){const e=new Uint8Array(t);return window.btoa(String.fromCharCode(...e)).replace(/([\+\/\=])/g,t=>Qe[t])}(await v.digest(Ke,t))}catch(t){return""}}const Ze=/data:(\w+\/\w+);base64/,ts=new ArrayBuffer(Math.pow(2,22));class es{constructor(){this.count=0}async newFrame(t,e,s,i){const n=Date.now(),r=this.count;this.count++;const[o,a]=function(t){const{atob:e}=window,s=[],i=[];let n=0;for(let r of t){const[t,o]=r.split(","),[a,h]=Ze.exec(t)||[];if(!h)continue;const l=e(o),{length:c}=l,u=new Dt(h,n,c);s.push(u),i.push(l),n+=c}const r=new Uint8Array(ts,0,n);n=0;for(let t of i){const{length:e}=t;for(let s=0;s<e;s++)r[n+s]=t.charCodeAt(s);n+=e}return[s,r]}(s),h=Ye(a),l=jt.fromObj(t),c=[];for(let t=0;t<e.length;t++)c.push(new Tt(o[t],jt.fromObj(e[t])));const u=[];for(let t=0;t<i.length;t++)u.push(new Tt(o[t+e.length],jt.fromObj(i[t])));const d=await h;return{meta:new Lt(r,n,l,c,d,u),buffer:a}}getCount(){return this.count}}class ss{constructor(t,e){Object.assign(this,{viewer:t,display:e})}toJSON(){return Object.values(this)}static fromList(t){const[e,s]=t;return new ss(is.fromList(e),ns.fromList(s))}}class is{constructor(t,e,s,i){Object.assign(this,{active:t,idle:e,left:s,visible:i})}toJSON(){return[this.active,this.idle,this.left,this.visible]}static fromList(t){return new is(t[0],t[1],t[2],t[3])}}class ns{constructor(t,e,s){Object.assign(this,{maxWidth:t,maxHeight:e,mode:s})}toJSON(){return[this.maxWidth,this.maxHeight,this.mode]}static fromList(t){return new ns(t[0],t[1],t[2])}}const rs=0,os=1,as=3,hs=1e3,ls=4e3;class cs{constructor(t,e,s,i){this.table=new Set,this.state=rs,Object.assign(this,{session:t,srvMgr:e,httpCli:s,netMon:i}),this.pingDataLoop()}finalize(){this.state=os}async pingDataLoop(){for(;;){if(await r(ls),this.state!=rs)return;if(this.netMon.isOffline||this.netMon.checkDfd)continue;const t=this.srvMgr.getData();if(t.length>0){const e=t[0];try{await this.netMon.ping(e)}catch(t){this.netMon.onFail(e)}}}}async onFail(t){if(this.netMon.isOffline||this.table.has(t.host))return Promise.resolve();switch(t.role){case k:case $:case D:break;default:return Promise.resolve()}this.table.add(t.host);for(let e=0;e<as;e++){this.netMon.checkDfd&&await this.netMon.checkDfd.getPromise();try{return await this.netMon.ping(t),this.table.delete(t.host),Promise.resolve()}catch(t){}if(this.state!==rs||!this.srvMgr.has(t))return this.table.delete(t.host),Promise.resolve()}switch(t.role){case k:await this.replaceCtrl(t);break;case $:case D:await this.replaceHost(t)}await r(hs),this.table.delete(t.host)}async replaceCtrl(t){const e=`screen-shares/${this.session}/new-hostname/${t.host}?serverRole=CTRL`,s=this.srvMgr.getWeb();let i=null;try{i=await this.httpCli.post(s,e,null)}catch(t){return void console.log("replaceCtrl post err: "+t)}try{const e=await i.json();t.host!=e.hostname&&this.srvMgr.setCtrl(e.hostname,e.region)}catch(t){return void console.log("replaceCtrl reading json response:"+t)}}async replaceHost(t){const e=`presenter/${this.session}/replaceHost`,s={role:t.role,replace:t.host},i=this.srvMgr.getCtrl();try{await this.httpCli.post(i,e,JSON.stringify(s))}catch(t){}}}const us="SLS:",ds="#",gs=0,fs=6e4,ps=!0;class bs extends _e{constructor(t,e){super(t,"UNSPECIFIED_CLUSTER","screenleap.com"),this.sDelegate=t,this.updateServers([{role:T,hostname:e}])}init(t,e,s,i,n){super.initTransport(t,e,ps);const r=new cs(e,this.srvMgr,this.httpCli,this.netMon);this.httpCli.addDelegate(r),Object.assign(this,{token:s,srvSup:r,pubBldr:new Kt(ds+t,Xt),frameBldr:new es,ptrBldr:new We(t)});const o={Authorization:us+s,ParticipantId:t};this.httpCli.setHeaders(o),this.updateServers(i),n&&this.initPeerCache(gs)}start(t){t&&this.updateServers(t),super.startTransport();const{id:e,session:s,msgMgr:i,token:n}=this,r=e,o={next(){const t=i.getSeq(`#${r}`)+1;let o=`m/${s}/chan/${r}/${t}?id=${e}`;return o+=`&Authorization=${us}${n}`},pub:t=>`m/${s}/pub/${r}/${t}`};this.chMgr.subscribe(r,o)}finalize(){this.srvSup.finalize(),super.finalize()}async sendFrame(t,e,s,i){if(this.netMon.isOffline)return Promise.reject();const{meta:n,buffer:r}=await this.frameBldr.newFrame(t,e,s,i),{key:o}=n;if(this.peerCache){const t=new Uint8Array(r.byteLength);t.set(r,0),this.peerCache&&this.peerCache.set(o,t)}let a="";return n.isFullFrame()?(a=xt,this.cliStats.add("countSentMetaFrame","full",1)):(a=Et,this.cliStats.add("countSentMetaFrame","diff",1)),this.pubMeta(a,n).catch(()=>{}),this.pubData(o,r)}sendPointer(t,e,s){if(this.netMon.isOffline)return;const i=this.ptrBldr.newPointer(t,e,s);i&&(this.cliStats.add("countSentMetaPointer",t,1),this.pubMeta(Rt,i).catch(()=>{}))}pubMeta(t,e){if(this.netMon.isOffline)return Promise.reject();const s=this.pubBldr.newMessage(t,e);Pt.push("msgTx",`#${this.id}`,s);const i=function(t){return JSON.stringify(t)+","}(s);return this.chMgr.send(this.id,s.id,i)}pubData(t,e){if(this.netMon.isOffline)return Promise.reject();const s=`d/${this.session}/data/${t}`,i=this.srvMgr.getData();if(0===i.length)return Promise.reject(He);const r=i[0],o=this.httpCli.post(r,s,e,{},!1,fs),a=new n(0);return this.netMon.setAbortable(a),o.then(t=>{const s=t.elapsed;t.ok&&(this.cliStats.add("byteSentDataFrame",r.host,e.length),this.cliStats.add("timeSentDataFrame",r.host,s),this.netMon.monitorSpeed(s))}).catch(()=>{}),Promise.race([o,a.getPromise()])}percentBandwidthUsed(){const t=this.srvMgr.getData()[0].host,e=this.cliStats.getValue("timeSentDataFrame",t)/1e3,s=this.cliStats.getValue("byteSentDataFrame",t),i=(Date.now()-this.ts)/1e3,n=s/i/(s/e)*100,r=s/e/1024,o=s/i/1024;return console.log(o.toFixed(2)+" of "+r.toFixed(2)+" KB/s. "+n.toFixed(2)+"%"),n}getHandler(t){let e;switch(t){case At:e=this.$$hs;break;case Ft:e=this.$$ss;break;case Ht:e=this.$$rq;break;case qt:e=this.$$cr;break;case Jt:e=this.$$dl;break;case zt:e=this.$$cb;break;case Bt:e=this.$$fu;break;case xt:e=this.$$ff;break;case Et:e=this.$$df;break;case Rt:e=this.$$mp}return null==e?super.getHandler(t):e.bind(this)}getCtrlHost(){const t=this.srvMgr.getCtrl();return null===t?"":t.host}$$hs(t){const e=super.$$hs(t);return this.sDelegate.onFrameRequest(),e}$$ss(t){const e=ss.fromList(t.data);return this.sDelegate.onSessionSummary(e),this.sesSum=e,null}$$rq(t){return this.delegate.onPresenterSwap(["REQUEST",t.data]),null}$$cr(t){return this.delegate.onPresenterSwap(["CANCEL",t.data]),null}$$dl(t){return this.sDelegate.onDailyLimit(t.data),null}$$cb(t){return this.sDelegate.onClipboard(t.data),null}$$fu(t){return this.sDelegate.onFrameRequest(),null}$$ff(t){return null}$$df(t){return null}$$mp(t){return null}}s.d(e,"Sharer",function(){return bs})}]);