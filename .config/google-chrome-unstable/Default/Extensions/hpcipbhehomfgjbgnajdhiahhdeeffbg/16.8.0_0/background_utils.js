function performOnActiveTab(e,t){try{chrome.tabs.query({currentWindow:!0,active:!0},function(t){0==t.length||0==t[0].url.indexOf("chrome-devtools")?chrome.tabs.query({active:!0,windowType:"normal"},function(t){t.length>0&&e(t)}):e(t)})}catch(e){t&&t()}}function getPopup(){return chrome.extension.getViews({type:"popup"})[0]}function copyToClipboard(e){var t=document.getElementById("clipboard");t.value=e,t.select(),document.execCommand("copy"),t.value=""}function resetExtension(){presenter.resetProperties(),resetChromeBadge()}function getIsAuthenticated(){return account.getIsAuthenticated()}function getAutoLoginAttempted(){return account.getAutoLoginAttempted()}function setAutoLoginAttempted(e){account.setAutoLoginAttempted(e)}function signInSuccessful(e,t){chrome.browserAction.setIcon({path:"screenleap_icon_19_19.png"}),saveSettings({userId:account.userInfo.userId,token:account.userInfo.token}),optionsEnabled()&&getSettings(["editOnCapture","autoCapture"],function(e){"undefined"!=e.autoCapture&&(options.autoCapture=e.autoCapture),"undefined"!=e.editOnCapture&&(options.editOnCapture=e.editOnCapture)}),markupPageTab?dispatch.trigger(markupPageTab,"signinSuccessful",{userInfo:e,screenshotSetId:t}):dispatch.triggerOnAllTabs("signinSuccessful",{userInfo:e})}function createAccountAndSignin(e,t,n){account.createAccountAndSignin(e,screenshotData.screenshotId,function(e,n){t&&t(e,n),signInSuccessful(e,n)},function(e){handleError(e,n)})}function signIn(e,t,n,o){e?t?account.signIn(e,t,screenshotData.screenshotId,function(t,o){setOption("emailAddress",e),n&&n(t,o),signInSuccessful(t,o)},function(e){handleError(e,o)}):o?o("Please enter the password for your account."):setErrorMessage("Please enter the password for your account."):o?o("Please enter the email address you used to sign up."):setErrorMessage("Please enter the email address you used to sign up.")}function doSignOut(e){account.signOut(),e&&closeMarkupPageTab(!0),clearSettings(["userId","token"]),resetOptions(),chrome.browserAction.setIcon({path:"screenleap_icon_19_19_off.png"})}dispatch.on("copyToClipboard",function(e){e&&e.text&&copyToClipboard(e.text)}),dispatch.on("closePopup",function(e){var t=getPopup();t&&t.updateUIAndClosePopupWindow(e.sharingState)});var options={editOnCapture:!0,emailAddress:"",autoCapture:!0};function setOption(e,t){options[e]=t,saveSetting(e,t),optionsEnabled()&&("editOnCapture"!=e||t||(options.autoCapture=!1,saveSetting("autoCapture",!1)))}function getOption(e){return options[e]}function isEditOnCapture(){return options.editOnCapture}function optionsEnabled(){return!1}function resetOptions(){options.autoCapture=!1,options.editOnCapture=!0}function saveSetting(e,t,n){chrome.storage.local.set({key:t},n)}function saveSettings(e,t){chrome.storage.local.set(e,t)}function clearSettings(e,t){chrome.storage.local.remove(e,t)}function getSettings(e,t){chrome.storage.local.get(e,function(n){t("string"==typeof e?n[e]:n)})}function handleError(e,t){var n=e?e.responseText:null,o=e?e.status:null;n=parseErrorMessage(n),t?t(o,n):setErrorMessage(n)}function parseErrorMessage(e){if(e){if(e)try{var t=JSON.parse(e);t&&t.errorMessage&&(e=t.errorMessage)}catch(e){}}else e="The Screenleap service is currently unavailable. Please try again in a few minutes.";return e}function setErrorMessage(e){dispatch.triggerOnActiveTab("showError",{title:"Screenleap Error",body:e})}function viewScreenleapSite(){openScreenshotsTab(account.getScreenleapSiteUrl())}window.addEventListener("load",function(){try{getSettings(["userId","token","emailAddress"],function(e){e.emailAddress&&(options.emailAddress=e.emailAddress),resetOptions(),e.userId&&e.token&&account.signInWithToken(e.userId,e.token,function(e){e.emailAddress!=options.emailAddress&&e.handle!=options.emailAddress&&setOption("emailAddress",e.emailAddress),signInSuccessful(e)},function(e){var t=e?e.status:"";401!=t&&403!=t||clearSettings(["userId","token"]),resetOptions()})})}catch(e){console.error("exception in background page",e)}});