function fullScreenshot(e,t){t?dispatch.trigger(t,"stopRegionCapture"):performOnActiveTab(function(e){dispatch.trigger(e,"stopRegionCapture")}),doCapture(t,e)}function regionScreenshot(e,t){null==t?performOnActiveTab(function(e){dispatch.trigger(e,"startRegionCapture",{autoCapture:options.autoCapture})}):dispatch.trigger(t,"startRegionCapture",{autoCapture:options.autoCapture})}function capture(e,t){performOnActiveTab(function(n){doCapture(n[0],t,null,e)})}dispatch.on("captureRegion",function(e,t){doCapture(t.tab,!0,e.rectangle)}),dispatch.on("fullScreenshot",function(e){capture()}),dispatch.on("regionScreenshot",function(e){regionScreenshot()});var screenshotsTab=null;function openNewScreenshotsTab(e){chrome.tabs.create({url:e},function(e){screenshotsTab=e})}function openScreenshotsTab(e){screenshotsTab?chrome.tabs.get(screenshotsTab.id,function(t){void 0===t?openNewScreenshotsTab(e):setTimeout(function(){chrome.tabs.update(t.id,{url:e,active:!0})},500)}):openNewScreenshotsTab(e)}function openSignup(){chrome.tabs.create({url:"https://www.screenleap.com/pricing"},function(e){})}var markupPageTab=null;function openNewMarkupPageTab(e,t){chrome.tabs.create({url:e},function(e){markupPageTab=e,t()})}function activateMarkupPageTab(){chrome.tabs.update(markupPageTab.id,{active:!0})}function openMarkupPageTab(e){var t=chrome.extension.getURL("markupPage.html");markupPageTab?chrome.tabs.reload(markupPageTab.id,function(){setTimeout(function(){activateMarkupPageTab(),e()},200)}):openNewMarkupPageTab(t,e)}function toggleCaptureRegionContextMenu(e){chrome.contextMenus&&(doExcludeUrl(e)?chrome.contextMenus.update(captureRegionMenuId,{enabled:!1}):chrome.contextMenus.update(captureRegionMenuId,{enabled:!0}))}function doExcludeUrl(e){return!e||0==e.indexOf("chrome")||0==e.indexOf("https://chrome.google.com/webstore/")}function closeMarkupPageTab(){clearScreenshotData(),markupPageTab&&chrome.tabs.remove(markupPageTab.id)}function openFeedbackTab(){var e="http://www.screenleap.com/feedback",t=getUserInfo();t&&(e+="?name="+t.firstName+" "+t.lastName+"&emailAddress="+t.emailAddress),chrome.tabs.create({url:e},function(e){})}chrome.tabs.onRemoved.addListener(function(e){markupPageTab&&markupPageTab.id==e&&(markupPageTab=null)}),chrome.tabs.onUpdated.addListener(function(e,t,n){!markupPageTab||markupPageTab.id!=e||n&&0==n.url.indexOf(markupPageTab.url)?toggleCaptureRegionContextMenu(n?n.url:null):markupPageTab=null}),chrome.tabs.onActivated.addListener(function(e){chrome.tabs.get(e.tabId,function(e){toggleCaptureRegionContextMenu(e?e.url:null)})});var templateCompiler=document.getElementById("templateCompiler").contentWindow,renderQueue=[],compiledTemplates=[];function compileTemplate(e,t){templateCompiler.postMessage({command:"compile",context:{name:e,source:t}},"*")}function renderTemplate(e,t,n){return renderQueue.push(n),templateCompiler.postMessage({command:"render",context:{name:e,json:t}},"*")}window.addEventListener("message",function(e){switch(e.data.command){case"compiled":compiledTemplates.push(e.data.name);break;case"rendered":renderQueue.shift()(e.data.html)}});var screenleapMenuId=chrome.contextMenus?chrome.contextMenus.create({title:"Screenleap",contexts:["all"],documentUrlPatterns:["http://*/*","https://*/*","ftp://*/*","file://*/*"],enabled:!0}):null,captureRegionMenuId=chrome.contextMenus?chrome.contextMenus.create({title:"Capture region",contexts:["all"],onclick:regionScreenshot,parentId:screenleapMenuId}):null,captureWindowMenuId=chrome.contextMenus?chrome.contextMenus.create({title:"Capture window",contexts:["all"],onclick:fullScreenshot,parentId:screenleapMenuId}):null,captureFormat="jpeg";function captureActiveTabAsDataUrl(e,t,n,a,r){try{t||(t=chrome.windows.WINDOW_ID_CURRENT);var o={format:captureFormat,quality:90};if(0==e.url.indexOf("chrome://")||0==e.url.indexOf("https://chrome.google.com"))return void presenter.setNextIntervalReady(n,"K");chrome.tabs.captureVisibleTab(t,o,function(e){chrome.runtime.lastError?("Failed to capture tab: unknown error"!=chrome.runtime.lastError.message&&console.log(chrome.runtime.lastError.message),setTimeout(r,1e3)):a(e)})}catch(e){r()}}function openNewTabOrUpdateCurrentTab(e,t){chrome.tabs.onUpdated.addListener(function(e,n,a){"complete"==n.status&&t&&t(a)}),presenter.instructionsTab?tabExists(presenter.instructionsTab.id,presenter.instructionsTabUrl,function(t){chrome.tabs.update(t.id,{url:e,active:!0,selected:!0})},function(){chrome.tabs.create({url:e})}):performOnActiveTab(function(t){-1!=t[0].url.indexOf(".screenleap.com")?chrome.tabs.update(t[0].id,{url:e,active:!0,selected:!0}):chrome.tabs.create({url:e})})}function activateInstructionsTab(e){e&&chrome.tabs.update(e.id,{active:!0,selected:!0})}function tabExists(e,t,n,a){chrome.windows.getAll({populate:!0},function(r){for(var o,c=0;o=r[c];c++)for(var u,i=0;u=o.tabs[i];i++)if(u.id==e&&u.url==t)return void(n&&n(u));a&&a()})}