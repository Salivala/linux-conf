var debugScreenshots=!1,screenshots={webBaseUrl:"http://www.screenleap.com",webBaseApiUrl:"https://www.screenleap.com/v1",canvas:null,account:null,listeners:{},setAccount:function(e){this.account=e},getScreenshotsTutorialUrl:function(){return this.webBaseUrl+"/screenshots/documentation"},getScreenshotsUrl:function(e){var t=this.account.getUserInfo();return this.webBaseApiUrl+(e?"":"/"+t.handle)+"/screenshots?userId="+t.userId+"&token="+t.token},appendUserInfo:function(e){if(this.account.getUserInfo()){var t=this.account.getUserInfo();e.userId=t.userId,e.feedHandle=t.handle,e.token=t.token}},on:function(e,t,n){n&&(this.context=n),this.listeners[e]?this.listeners[e].push({callback:t,context:n}):this.listeners[e]=[{callback:t,context:n}]},trigger:function(e,t){var n=this.listeners[e];if(n)for(var s=0;s<n.length;s++)n[s].callback.call(n[s].context||this,t)},createScreenshot:function(e,t,n,s){s||(s=0);var r=screenleapUtils.convertDataUrlToBinary(e.imageSrcOriginal),a={width:e.width,height:e.height,sourceUrl:e.sourceUrl};this.appendUserInfo(a);var o=this;screenleapUtils.ajax({url:this.webBaseApiUrl+"/screenshots",params:a,data:r.data,type:"POST",headers:{},contentType:r.contentType},function(e){t(JSON.parse(e))},function(r){401==r.status?(o.account.reset(),o.trigger("unauthorized",{screenshotEvent:"createScreenshot"}),o.createScreenshot(e,t,n,s)):s<3&&r.status>=500?(s++,setTimeout(function(){o.createScreenshot(e,t,n,s)},2e3*s)):n(r)})},saveScreenshot:function(e,t,n,s,r,a){if(r||(r=screenleapUtils.combineMarkupCodeAndImageData(t.markupCodeLength,t.markupCode,t.imageDataString)),r){for(var o in r.params)t[o]=r.params[o];delete t.imageDataString,delete t.markupCode}var i=this;screenleapUtils.ajax({url:this.webBaseApiUrl+"/screenshots/"+e,params:t,data:r?r.data:null,headers:r?r.headers:null,type:"PUT",contentType:r?r.contentType:null},function(e){debugScreenshots&&console.log("saveScreenshot "+e),n(JSON.parse(e))},function(e){401==e.status?i.trigger("unauthorized",{screenshotEvent:"saveScreenshot"}):a<3&&e.status>=500?(a++,setTimeout(function(){i.saveScreenshot(a)},2e3*a)):s(e)})},getShortenedViewUrl:function(e,t,n){var s='{"longUrl": "'+this.webBaseUrl+e+'"}';screenleapUtils.ajax({url:"https://www.googleapis.com/urlshortener/v1/url",type:"POST",data:s,contentType:"application/json; charset=utf-8"},function(e){t(JSON.parse(e).id)},n)},deleteScreenshot:function(e,t,n){var s={};this.appendUserInfo(s),screenleapUtils.ajax({url:this.webBaseApiUrl+"/screenshots/"+e,params:s,type:"DELETE"},t,n)},emailScreenshot:function(e,t,n,s){var r={emailAddresses:t};this.appendUserInfo(r);screenleapUtils.ajax({url:this.webBaseApiUrl+"/screenshots/"+e+"/email",params:r,type:"POST"},n,function(e){401==e.status?this.trigger("unauthorized",{screenshotEvent:"emailScreenshot"}):s&&s()})}};function doCapture(e,t,n,s){clearScreenshotData();try{var r=e.url;captureActiveTabAsDataUrl(e,null,null,function(a){t?doEditOrSaveCapture(a,r,n,function(){s&&s(),isEditOnCapture()||dispatch.trigger(e,"savedRegion")},function(){isEditOnCapture()||dispatch.trigger(e,"failedSavingRegion")},function(){isEditOnCapture()||dispatch.trigger(e,"savingRegion")}):doEditOrSaveCapture(a,r,n,s,function(e){e=parseErrorMessage(e),setErrorMessage(e)},null)})}catch(e){setErrorMessage("Unexpected error: "+e)}}function cropScreenshot(e,t,n){var s=new Image;s.onload=function(){if(!t||t.width==this.width&&t.height==this.height)n({width:this.width,height:this.height,imageSrcOriginal:e});else{t.width+t.x>this.width&&(debugScreenshots&&console.log("Trying to crop image to "+(t.width+t.x)+" which is larger than image width "+this.width+".fixing..."),t.width=this.width-t.x),t.height+t.y>this.height&&(debugScreenshots&&console.log("Trying to crop image to "+(t.height+t.y)+" which is larger than image height "+this.height+".fixing..."),t.height=this.height-t.y);var s=document.getElementById("screenleapScreenshotCanvas");s.width=t.width,s.height=t.height,s.getContext("2d").drawImage(this,t.x,t.y,t.width,t.height,0,0,t.width,t.height),e=s.toDataURL("image/png"),n({width:t.width,height:t.height,imageSrcOriginal:e})}},s.onerror=function(){dispatch.triggerOnActiveTab("showError",{title:"Screenleap Error",body:"We were unable to load the screenshot you took. Please try taking the screenshot again. You can contact us at support@screenleap.com if you continue to experience problems."})},s.src=e}function doEditOrSaveCapture(e,t,n,s,r,a){a&&a(),cropScreenshot(e,n,function(e){(screenshotData=e).sourceUrl=t,screenshotData.isEditable=!0,screenshotData.screenshotSetId=null,debugScreenshots&&console.log("doEditOrSaveCapture: opening show image tab"),openMarkupPageTab(function(){screenshots.createScreenshot(screenshotData,function(e){for(var t in e)screenshotData[t]=e[t];dispatch.trigger(markupPageTab,"screenshotInfo",{screenshotInfo:e})},function(e,t,n){dispatch.trigger(markupPageTab,"saveScreenshotError",{xhr:n})})})})}var screenshotData={};function updateScreenshot(e,t,n,s){debugScreenshots&&console.log("Calling deprecated method, use updateScreenshotData instead"),screenshotData.title=e,screenshotData.description=t,screenshotData.screenshotSetId=n,s&&(screenshotData.markupCode=s)}function updateScreenshotData(e){for(var t in e)e[t]&&(screenshotData[t]=e[t])}function getScreenshotData(){return screenshotData}function clearScreenshotData(){screenshotData={}}function viewScreenshots(e){openScreenshotsTab(screenshots.getScreenshotsUrl(e))}function viewScreenshotsTutorial(){openScreenshotsTab(screenshots.getScreenshotsTutorialUrl())}screenshots.setAccount(account),screenshots.on("unauthorized",function(e){doSignOut(!1),markupPageTab&&dispatch.trigger(markupPageTab,"unauthorized",{screenshotEvent:e.screenshotEvent})});