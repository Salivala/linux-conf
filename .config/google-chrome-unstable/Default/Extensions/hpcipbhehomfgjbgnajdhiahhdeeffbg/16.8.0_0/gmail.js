var THIRTY_DAYS=2592e6;InboxSDK.load("1","Screenleap").then(function(e){e.Compose.registerComposeViewHandler(function(n){n.addButton({title:"Start screen share and insert link",iconUrl:chrome.extension.getURL("screenleap_icon_16_16.png"),onClick:function(n){var r=!0;setTimeout(function(){r&&showPromptDialog('Starting screen share...<img src="https://www.screenleap.com/img/indicator.gif" class="indicator" alt=""/>',"screenleap-green","This may take a few seconds. Thank you for your patience.",null,{label:"Cancel",click:function(){hideScreenleapExtensionDialog()}})},1e3),dispatch.on("hideIntegrationScreenShareStartingDialog",function(){r=!1,hideScreenleapExtensionDialog()}),dispatch.on("startIntegrationScreenShareSuccessful",function(e){r=!1,hideScreenleapExtensionDialog();var t=e.viewerUrl;n.composeView.insertHTMLIntoBodyAtCursor('View my screen: <b><a href="'+t+'">'+t+"</a></b><br><br>"),chrome.storage.sync.get(["gmailScreenShareInstructionShownCount","gmailScreenShareInstructionLastShownTimestamp"],function(e){var n=0,r=null;e.gmailScreenShareInstructionShownCount&&(n=e.gmailScreenShareInstructionShownCount),e.gmailScreenShareInstructionLastShownTimestamp&&(r=e.gmailScreenShareInstructionLastShownTimestamp),(n<3||r<(new Date).getTime()-THIRTY_DAYS)&&(showPromptDialog("Your screen is shared","screenleap-green","The share link has been inserted into your email. Please send the link to your viewers and ask them to click on it to see your screen.<br><br>You can stop your screen share by clicking on the Screenleap icon next to the address bar and then clicking on the <b>Stop sharing</b> button.",null,{label:"OK",click:function(){hideScreenleapExtensionDialog()}}),chrome.storage.sync.set({gmailScreenShareInstructionShownCount:++n,gmailScreenShareInstructionLastShownTimestamp:(new Date).getTime()}))})}),dispatch.on("startIntegrationScreenShareUnsuccessful",function(n){r=!1,hideScreenleapExtensionDialog(),401==n.status?showPromptDialog("You need to grant permission to share screen","screenleap-red","You need to select a screen in order to enable full screen sharing.",null,{label:"OK",click:function(){hideScreenleapExtensionDialog()}}):403==n.status?showPromptDialog("Screenleap account not found","screenleap-red","We could not find a Screenleap account with your Gmail email address ("+e.User.getEmailAddress()+'). Please go to <a href="https://www.screenleap.com/pricing" target="_blank">http://www.screenleap.com</a> and create an account and then try again.',null,{label:"OK",click:function(){hideScreenleapExtensionDialog()}}):dispatch.trigger("showShareFailed",n)}),dispatch.on("insertLinkForActiveIntegrationScreenShare",function(e){r=!1,hideScreenleapExtensionDialog();var t=e.viewerUrl;n.composeView.insertHTMLIntoBodyAtCursor('View my screen: <b><a href="'+t+'">'+t+"</a></b><br><br>"),showPromptDialog("Your screen is already being shared","screenleap-green","The share link has been re-inserted into your email for you to send to other viewers.",null,{label:"OK",click:function(){hideScreenleapExtensionDialog()}})}),dispatch.trigger("startNewShare",{origin:"GMAIL",emailAddress:e.User.getEmailAddress(),isCaptureEntireScreen:!0})}}),n.addButton({title:"Start browser share and insert link",iconUrl:chrome.extension.getURL("share_browser_window.png"),onClick:function(n){var r=!0;setTimeout(function(){r&&showPromptDialog('Starting screen share...<img src="https://www.screenleap.com/img/indicator.gif" class="indicator" alt=""/>',"screenleap-green","This may take a few seconds. Thank you for your patience.",null,{label:"Cancel",click:function(){hideScreenleapExtensionDialog()}})},1e3),dispatch.on("startIntegrationBrowserShareSuccessful",function(e){r=!1,hideScreenleapExtensionDialog();var t=e.viewerUrl;console.log("INSERTING BROWSER VIEWER URL"),n.composeView.insertHTMLIntoBodyAtCursor('View my browser window: <b><a href="'+t+'">'+t+"</a></b><br><br>"),chrome.storage.sync.get(["gmailBrowserShareInstructionShownCount","gmailBrowserShareInstructionLastShownTimestamp"],function(e){var n=0,r=0;e.gmailBrowserShareInstructionShownCount&&(n=e.gmailBrowserShareInstructionShownCount),e.gmailBrowserShareInstructionLastShownTimestamp&&(r=e.gmailBrowserShareInstructionLastShownTimestamp),(n<3||r<(new Date).getTime()-THIRTY_DAYS)&&(showPromptDialog("Your browser window is shared","screenleap-green","The share link has been inserted into your email. Please send the link to your viewers and ask them to click on it to see your browser window.<br><br>You can stop your browser share by clicking on the Screenleap icon next to the address bar and then clicking on the <b>Stop sharing</b> button.",null,{label:"OK",click:function(){hideScreenleapExtensionDialog()}}),chrome.storage.sync.set({gmailBrowserShareInstructionShownCount:++n,gmailBrowserShareInstructionLastShownTimestamp:(new Date).getTime()}))})}),dispatch.on("startIntegrationBrowserShareUnsuccessful",function(n){r=!1,hideScreenleapExtensionDialog(),403==n.status?showPromptDialog("Screenleap account not found","screenleap-red","We could not find a Screenleap account with your Gmail email address ("+e.User.getEmailAddress()+'). Please go to <a href="https://www.screenleap.com/pricing" target="_blank">http://www.screenleap.com</a> and create an account and then try again.',null,{label:"OK",click:function(){hideScreenleapExtensionDialog()}}):dispatch.trigger("showShareFailed",n)}),dispatch.on("insertLinkForActiveIntegrationBrowserShare",function(e){r=!1,hideScreenleapExtensionDialog();var t=e.viewerUrl;n.composeView.insertHTMLIntoBodyAtCursor('Please click this link to see my screen: <b><a href="'+t+'">'+t+"</a></b><br><br>"),showPromptDialog("Your browser window is already being shared","screenleap-green","The share link has been re-inserted into your email for you to send to other viewers.",null,{label:"OK",click:function(){hideScreenleapExtensionDialog()}})}),dispatch.trigger("startNewShare",{origin:"GMAIL",emailAddress:e.User.getEmailAddress(),isCaptureEntireScreen:!1})}})})});